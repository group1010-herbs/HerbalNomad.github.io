<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>Kavutiri NDVI Interactive Dashboard</title>

<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css">

<style>
:root{--bg:#0f1724;--card:#0b1220;--muted:#94a3b8;--accent:#06b6d4}
html,body{margin:0;font-family:Inter,system-ui;background:var(--bg);color:#e6eef8}
.container{padding:14px}
.card{background:var(--card);padding:14px;border-radius:12px;margin-bottom:14px}
canvas{background:rgba(255,255,255,0.03);border-radius:10px}
#map{height:310px;border-radius:10px;margin-top:10px}
.stats{font-size:13px;color:#a3d8e6;margin-top:6px}
.loading{text-align:center;padding:10px;color:var(--muted)}
.error{color:#ff7b7b;text-align:center;font-size:14px;margin-top:20px}
</style>
</head>

<body>
<div class="container">

  <div class="card">
    <canvas id="ndviChart" height="230"></canvas>
    <div class="stats" id="stats">Statistics: —</div>
  </div>

  <div class="card">
    <div id="map"></div>
  </div>

  <div id="loader" class="loading">Loading NDVI data...</div>

</div>

<script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/luxon@3.4.4/build/global/luxon.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/chartjs-adapter-luxon@1.4.0"></script>
<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

<script>
let chart,map,markers=[];

async function loadNDVI(){
  try{
    const res=await fetch("data/kavutiri.json");
    return await res.json();
  }catch(e){
    return null;
  }
}

function updateStats(records){
  const vals=records.map(r=>r.ndvi);
  const min=Math.min(...vals).toFixed(2);
  const max=Math.max(...vals).toFixed(2);
  const avg=(vals.reduce((a,b)=>a+b,0)/vals.length).toFixed(2);
  document.getElementById('stats').innerHTML =
    `Min: ${min} | Max: ${max} | Avg: ${avg}`;
}

function buildChart(records){
  const labels=records.map(r=>r.date);
  const vals=records.map(r=>r.ndvi);
  if(chart)chart.destroy();
  chart=new Chart(document.getElementById("ndviChart"),{
    type:"line",
    data:{labels,
      datasets:[{data:vals,borderColor:"#00e2ff",
      backgroundColor:"rgba(0,226,255,0.25)",fill:true,tension:0.15}]},
    options:{
      plugins:{legend:{display:false}},
      scales:{x:{type:"time",time:{unit:"month"}},
              y:{min:-0.5,max:1}},
      onHover(e,active){
        if(active.length){highlightPoint(active[0].index);}
      }
    }
  });
}

function highlightPoint(i){
 markers.forEach((m,x)=>m.setStyle({
   color: x===i?"#ffffff":"#06b6d4",
   radius: x===i?7:4
 }));
}

function buildMap(records){
  if(!map){
    map=L.map("map").setView([-0.5,37.9],11);
    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png',{maxZoom:19})
    .addTo(map);
  }
  markers.forEach(m=>map.removeLayer(m)); markers=[];
  records.forEach((r,i)=>{
    if(r.lat && r.lon){
      const mk=L.circleMarker([r.lat,r.lon],
      {radius:4,color:"#06b6d4",fillOpacity:0.6})
      .on("mouseover",()=>highlightPoint(i))
      .bindPopup(`<b>${r.date}</b><br>NDVI: ${r.ndvi}`);
      mk.addTo(map); markers.push(mk);
    }
  });
}

(async()=>{
  const data=await loadNDVI();
  const loader=document.getElementById("loader");
  if(!data||!data.records){
    loader.outerHTML='<div class="error">❌ Data not found (expected: data/kavutiri.json)</div>';
    return;
  }
  buildChart(data.records);
  buildMap(data.records);
  updateStats(data.records);
  loader.style.display="none";
})();
</script>

</body>
</html>
