<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Kavutiri NDVI Timeline — Enhanced</title>
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" crossorigin="" />
  <style>
    :root{--bg:#0f1724;--card:#0b1220;--muted:#94a3b8;--accent:#06b6d4}
    html,body{height:100%;margin:0;font-family:Inter,system-ui,Segoe UI,Roboto,'Helvetica Neue',Arial;color:#e6eef8;background:linear-gradient(180deg,#071122 0%, #0b1630 100%);}    
    .container{max-width:1100px;margin:24px auto;padding:18px}
    header{display:flex;align-items:center;gap:12px;margin-bottom:14px}
    h1{font-size:20px;margin:0}
    .controls{display:grid;grid-template-columns:repeat(3,1fr);gap:12px;margin-bottom:12px}
    .card{background:var(--card);padding:12px;border-radius:12px;box-shadow:0 6px 18px rgba(2,6,23,0.6)}
    label{display:block;font-size:12px;color:var(--muted);margin-bottom:6px}
    input[type=file]{width:100%}
    .row{display:flex;gap:12px}
    .chart-row{display:grid;grid-template-columns:2fr 1fr;gap:12px;margin-top:12px}
    canvas{background:linear-gradient(180deg, rgba(255,255,255,0.01), rgba(255,255,255,0.02));border-radius:10px;padding:8px}
    #map{height:320px;border-radius:10px}
    .stats{display:flex;flex-direction:column;gap:6px}
    .stat{font-size:14px}
    .small{font-size:12px;color:var(--muted)}
    .btn{background:var(--accent);color:#04202a;border:none;padding:8px 10px;border-radius:8px;cursor:pointer}
    .btn.secondary{background:transparent;border:1px solid rgba(255,255,255,0.06);color:var(--muted)}
    footer{margin-top:16px;color:var(--muted);font-size:12px}
    @media(max-width:900px){.controls{grid-template-columns:1fr}.chart-row{grid-template-columns:1fr}}
  </style>
</head>
<body>
  <div class="container">
    <header>
      <img src="" alt="" style="width:46px;height:46px;border-radius:8px;background:linear-gradient(90deg,#06b6d4,#3b82f6);">
      <div>
        <h1>Kavutiri NDVI Timeline — Enhanced</h1>
        <div class="small">Improved UX, analytics, anomaly detection, smoothing, export and map integration</div>
      </div>
    </header>

    <div class="controls">
      <div class="card">
        <label for="fileInput">Load CSV (required columns: date, ndvi[, lat, lon])</label>
        <input id="fileInput" type="file" accept="text/csv,text/plain" />
        <div class="small">Date accepted formats: YYYY-MM-DD or ISO. Lines starting with # ignored.</div>
      </div>

      <div class="card">
        <label>Time range</label>
        <div class="row">
          <input id="startDate" type="date" style="flex:1" />
          <input id="endDate" type="date" style="flex:1" />
        </div>
        <div style="margin-top:8px;display:flex;gap:8px">
          <button id="applyRange" class="btn secondary">Apply</button>
          <button id="resetRange" class="btn">Reset</button>
        </div>
      </div>

      <div class="card">
        <label>Smoothing & anomaly</label>
        <div style="display:flex;gap:8px;align-items:center">
          <div style="flex:1">
            <label class="small">Rolling window (samples)</label>
            <input id="smoothWindow" type="range" min="0" max="12" value="0" />
            <div class="small">0 = no smoothing</div>
          </div>
          <div style="width:110px;">
            <label class="small">Z-score thresh.</label>
            <input id="zthresh" type="number" step="0.1" value="2.5" style="width:100%" />
          </div>
        </div>
      </div>

      <div class="card">
        <label>Chart actions</label>
        <div style="display:flex;gap:8px;flex-wrap:wrap">
          <button id="exportPng" class="btn">Export PNG</button>
          <button id="downloadFiltered" class="btn secondary">Download CSV</button>
          <button id="toggleMarkers" class="btn secondary">Toggle Map Marker</button>
          <button id="calcStats" class="btn secondary">Recalc stats</button>
        </div>
      </div>

      <div class="card">
        <label>Visualization</label>
        <div style="display:flex;gap:8px">
          <button id="showHistogram" class="btn secondary">Histogram</button>
          <button id="showBox" class="btn secondary">Boxplot</button>
          <button id="showSeries" class="btn">Time series</button>
        </div>
      </div>

      <div class="card stats" id="statsCard">
        <label>Summary statistics</label>
        <div class="stat" id="count">Count: —</div>
        <div class="stat" id="mean">Mean NDVI: —</div>
        <div class="stat" id="median">Median NDVI: —</div>
        <div class="stat" id="std">Std. dev: —</div>
        <div class="stat" id="trend">Trend (slope): —</div>
      </div>
    </div>

    <div class="chart-row">
      <div class="card">
        <canvas id="ndviChart" height="220"></canvas>
        <div style="display:flex;gap:8px;margin-top:8px;align-items:center">
          <div class="small">Highlight anomalies: points outside ±<span id="zshow">2.5</span>σ</div>
          <div style="flex:1"></div>
          <div class="small">Smoothing window: <span id="wshow">0</span></div>
        </div>
      </div>

      <div class="card">
        <div id="map"></div>
        <div style="margin-top:8px;display:flex;gap:8px;justify-content:flex-end">
          <button id="zoomToData" class="btn secondary">Zoom to last</button>
        </div>
      </div>
    </div>

    <div style="display:grid;grid-template-columns:1fr 1fr;gap:12px;margin-top:12px">
      <div class="card">
        <canvas id="histChart" height="160"></canvas>
      </div>
      <div class="card">
        <canvas id="boxChart" height="160"></canvas>
      </div>
    </div>

    <footer>Tips: you can drag-select dates, adjust smoothing, then export the filtered CSV or PNG. Works in modern browsers (Edge/Chrome/Firefox).</footer>
  </div>

  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
  <script>
  // Helper utils
  function parseCSV(text) {
    const rows = text.trim().split('\n').filter(function(r){ return r && !r.startsWith('#'); });
    const data = [];
    if(rows.length === 0) return data;
    const header = rows[0].split(',').map(function(h){ return h.trim().toLowerCase(); });
    const iDate = header.indexOf('date');
    const iNdvi = header.indexOf('ndvi');
    const iLat = header.indexOf('lat');
    const iLon = header.indexOf('lon');
    for(let r = 1; r < rows.length; r++) {
      const cols = rows[r].split(',').map(function(c){ return c.trim(); });
      if(iDate < 0 || iNdvi < 0) continue;
      const dStr = cols[iDate];
      const d = new Date(dStr);
      const nd = parseFloat(cols[iNdvi]);
      const lat = iLat >= 0 ? parseFloat(cols[iLat]) : null;
      const lon = iLon >= 0 ? parseFloat(cols[iLon]) : null;
      if(!isNaN(d.getTime()) && !isNaN(nd)) {
        data.push({ date: new Date(d.getFullYear(), d.getMonth(), d.getDate()), ndvi: nd, lat: lat, lon: lon });
      }
    }
    return data.sort(function(a,b){ return a.date - b.date; });
  }

  function rollingMean(values, window) {
    if(window <= 1) return values.slice();
    const out = [];
    for(let i = 0; i < values.length; i++) {
      const half = Math.floor((window - 1) / 2);
      const start = Math.max(0, i - half);
      const end = Math.min(values.length - 1, i + (window - 1 - half));
      let sum = 0;
      let c = 0;
      for(let j = start; j <= end; j++) { sum += values[j]; c++; }
      out.push(sum / c);
    }
    return out;
  }

  function stats(values) {
    const n = values.length;
    if(n === 0) return null;
    const mean = values.reduce(function(a,b){ return a + b; }, 0) / n;
    const sorted = values.slice().sort(function(a,b){ return a - b; });
    const mid = Math.floor(n / 2);
    var median;
    if(n % 2) median = sorted[mid]; else median = (sorted[mid - 1] + sorted[mid]) / 2;
    var sd = Math.sqrt(values.reduce(function(acc, v){ return acc + (v - mean) * (v - mean); }, 0) / n);
    return { count: n, mean: mean, median: median, sd: sd };
  }

  function linearTrendSlope(dates, values) {
    var n = values.length;
    if(n < 2) return 0;
    var xs = dates.map(function(d){ return d.getTime() / 86400000; });
    var xbar = xs.reduce(function(a,b){ return a + b; }, 0) / n;
    var ybar = values.reduce(function(a,b){ return a + b; }, 0) / n;
    var num = 0, den = 0;
    for(var i = 0; i < n; i++) {
      num += (xs[i] - xbar) * (values[i] - ybar);
      den += (xs[i] - xbar) * (xs[i] - xbar);
    }
    return den === 0 ? 0 : num / den;
  }

  // App state
  var rawData = [];
  var filtered = [];
  var marker = null;
  var showMarker = true;

  // Map
  var map = L.map('map', { attributionControl: false }).setView([-0.5, 37.9], 8);
  L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', { maxZoom: 19 }).addTo(map);

  // UI references
  var fileInput = document.getElementById('fileInput');
  var startDate = document.getElementById('startDate');
  var endDate = document.getElementById('endDate');
  var applyRange = document.getElementById('applyRange');
  var resetRange = document.getElementById('resetRange');
  var smoothWindow = document.getElementById('smoothWindow');
  var wshow = document.getElementById('wshow');
  var zthresh = document.getElementById('zthresh');
  var zshow = document.getElementById('zshow');
  var exportPng = document.getElementById('exportPng');
  var downloadFiltered = document.getElementById('downloadFiltered');
  var toggleMarkers = document.getElementById('toggleMarkers');
  var calcStats = document.getElementById('calcStats');
  var showHistogram = document.getElementById('showHistogram');
  var showBox = document.getElementById('showBox');
  var showSeries = document.getElementById('showSeries');
  var zoomToData = document.getElementById('zoomToData');

  // Stats nodes
  var countNode = document.getElementById('count');
  var meanNode = document.getElementById('mean');
  var medianNode = document.getElementById('median');
  var stdNode = document.getElementById('std');
  var trendNode = document.getElementById('trend');

  // Simple gradient helper (safe to call before Chart instantiation)
  function createGradient(canvas) {
    try {
      var ctx = canvas.getContext('2d');
      var g = ctx.createLinearGradient(0, 0, 0, 240);
      g.addColorStop(0, 'rgba(6,182,212,0.12)');
      g.addColorStop(1, 'rgba(6,182,212,0.02)');
      return g;
    } catch (e) {
      return 'rgba(6,182,212,0.12)';
    }
  }

  // Charts
  var ndviCtx = document.getElementById('ndviChart');
  var histCtx = document.getElementById('histChart');
  var boxCtx = document.getElementById('boxChart');

  var ndviChart = new Chart(ndviCtx, {
    type: 'line',
    data: {
      labels: [],
      datasets: [
        {
          label: 'NDVI',
          data: [],
          pointRadius: 4,
          pointHoverRadius: 6,
          fill: true,
          backgroundColor: createGradient(ndviCtx),
          borderColor: 'rgba(6,182,212,0.9)',
          tension: 0.15
        }
      ]
    },
    options: {
      plugins: {
        legend: { display: false },
        tooltip: { mode: 'index', intersect: false }
      },
      scales: {
        x: { type: 'time', time: { unit: 'month' } },
        y: { min: -0.5, max: 1 }
      }
    }
  });

  var histChart = new Chart(histCtx, {
    type: 'bar',
    data: { labels: [], datasets: [{ label: 'count', data: [] }] },
    options: { plugins: { legend: { display: false } }, scales: { x: { title: { display: true, text: 'NDVI bins' } }, y: { title: { display: true, text: 'Count' } } } }
  );

  // Use a simple bar as a placeholder for boxplot (avoids plugin dependency)
  var boxChart = new Chart(boxCtx, {
    type: 'bar',
    data: { labels: ['NDVI'], datasets: [{ label: 'IQR', data: [0] }] },
    options: { plugins: { legend: { display: false } } }
  });

  // Load file
  fileInput.addEventListener('change', async function(e) {
    var f = e.target.files[0];
    if(!f) return;
    var text = await f.text();
    rawData = parseCSV(text);
    if(rawData.length) {
      var min = rawData[0].date;
      var max = rawData[rawData.length - 1].date;
      startDate.value = toInputDate(min);
      endDate.value = toInputDate(max);
    }
    applyFiltersAndRender();
  });

  function toInputDate(d) { if(!d) return ''; return d.toISOString().slice(0,10); }

  applyRange.addEventListener('click', function() { applyFiltersAndRender(); });

  resetRange.addEventListener('click', function() {
    if(rawData.length) {
      startDate.value = toInputDate(rawData[0].date);
      endDate.value = toInputDate(rawData[rawData.length - 1].date);
      applyFiltersAndRender();
    }
  });

  smoothWindow.addEventListener('input', function() { wshow.textContent = smoothWindow.value; applyFiltersAndRender(); });
  zthresh.addEventListener('input', function() { zshow.textContent = zthresh.value; applyFiltersAndRender(); });

  toggleMarkers.addEventListener('click', function() {
    showMarker = !showMarker;
    if(!showMarker && marker) {
      map.removeLayer(marker);
      marker = null;
    } else {
      applyMarker();
    }
  });

  exportPng.addEventListener('click', function() {
    var a = document.createElement('a');
    a.href = ndviChart.toBase64Image();
    a.download = 'kavutiri_ndvi_chart.png';
    a.click();
  });

  downloadFiltered.addEventListener('click', function() {
    if(!filtered.length) return alert('No data to download');
    var csv = 'date,ndvi,lat,lon\n';
    for(var i = 0; i < filtered.length; i++) {
      var r = filtered[i];
      csv += r.date.toISOString().slice(0,10) + ',' + r.ndvi;
      if(r.lat != null) csv += ',' + r.lat; else csv += ',';
      if(r.lon != null) csv += ',' + r.lon; else csv += ',';
      csv += '\n';
    }
    var blob = new Blob([csv], { type: 'text/csv' });
    var url = URL.createObjectURL(blob);
    var a = document.createElement('a');
    a.href = url;
    a.download = 'filtered_kavutiri_ndvi.csv';
    a.click();
    URL.revokeObjectURL(url);
  });

  calcStats.addEventListener('click', function() { updateStatsDisplay(); });
  showHistogram.addEventListener('click', function() { document.getElementById('histChart').parentElement.scrollIntoView({ behavior: 'smooth' }); renderHistogram(); });
  showBox.addEventListener('click', function() { document.getElementById('boxChart').parentElement.scrollIntoView({ behavior: 'smooth' }); renderBoxplot(); });
  showSeries.addEventListener('click', function() { ndviCtx.scrollIntoView({ behavior: 'smooth' }); });
  zoomToData.addEventListener('click', function() { if(filtered.length) { var last = filtered[filtered.length - 1]; if(last.lat != null && last.lon != null) map.setView([last.lat, last.lon], 13); } });

  function applyFiltersAndRender() {
    var data = rawData.slice();
    if(startDate.value) {
      var s = new Date(startDate.value);
      data = data.filter(function(d){ return d.date >= s; });
    }
    if(endDate.value) {
      var e = new Date(endDate.value);
      data = data.filter(function(d){ return d.date <= e; });
    }

    var dates = data.map(function(d){ return d.date; });
    var vals = data.map(function(d){ return d.ndvi; });

    var w = parseInt(smoothWindow.value) || 0;
    var smoothVals = w > 1 ? rollingMean(vals, w) : vals.slice();

    var st = stats(smoothVals);
    var anomalies = [];
    if(st) {
      var zt = parseFloat(zthresh.value) || 2.5;
      for(var i = 0; i < smoothVals.length; i++) {
        var z = st.sd === 0 ? 0 : (smoothVals[i] - st.mean) / st.sd;
        if(Math.abs(z) >= zt) anomalies.push(i);
      }
    }

    filtered = data.map(function(d, i) {
      return { date: d.date, ndvi: smoothVals[i], raw: d.ndvi, lat: d.lat, lon: d.lon, anomaly: anomalies.indexOf(i) >= 0 };
    });

    // update chart
    ndviChart.data.labels = filtered.map(function(r){ return r.date; });
    ndviChart.data.datasets[0].data = filtered.map(function(r){ return { x: r.date, y: r.ndvi }; });
    ndviChart.update();

    applyMarker();
    updateStatsDisplay();
    renderHistogram();
    renderBoxplot();
  }

  function applyMarker() {
    if(!showMarker) return;
    if(marker) {
      map.removeLayer(marker);
      marker = null;
    }
    if(filtered.length && filtered[filtered.length - 1].lat != null && filtered[filtered.length - 1].lon != null) {
      var last = filtered[filtered.length - 1];
      marker = L.marker([last.lat, last.lon]).addTo(map).bindPopup('Sample: ' + last.date.toISOString().slice(0,10) + '<br>NDVI: ' + last.ndvi.toFixed(3) + ' (raw: ' + last.raw.toFixed(3) + ')');
      map.setView([last.lat, last.lon], 13);
    }
  }

  function updateStatsDisplay() {
    if(!filtered.length) {
      countNode.textContent = 'Count: 0';
      meanNode.textContent = 'Mean NDVI: —';
      medianNode.textContent = 'Median NDVI: —';
      stdNode.textContent = 'Std. dev: —';
      trendNode.textContent = 'Trend (slope): —';
      return;
    }
    var vals = filtered.map(function(d){ return d.ndvi; });
    var s = stats(vals);
    countNode.textContent = 'Count: ' + s.count;
    meanNode.textContent = 'Mean NDVI: ' + s.mean.toFixed(4);
    medianNode.textContent = 'Median NDVI: ' + s.median.toFixed(4);
    stdNode.textContent = 'Std. dev: ' + s.sd.toFixed(4);
    var slope = linearTrendSlope(filtered.map(function(d){ return d.date; }), vals);
    trendNode.textContent = 'Trend: ' + (slope * 365).toFixed(6) + ' NDVI/year';
  }

  function renderHistogram() {
    if(!filtered.length) return;
    var vals = filtered.map(function(d){ return d.ndvi; });
    var bins = 12;
    var min = Math.min.apply(null, vals);
    var max = Math.max.apply(null, vals);
    var width = (max - min) / (bins - 1) || 0.1;
    var labels = [];
    var counts = new Array(bins).fill(0);
    for(var i = 0; i < bins; i++) labels.push((min + i * width).toFixed(3));
    for(var j = 0; j < vals.length; j++) {
      var v = vals[j];
      var idx = Math.floor((v - min) / width);
      if(idx < 0) idx = 0;
      if(idx >= bins) idx = bins - 1;
      counts[idx]++;
    }
    histChart.data.labels = labels;
    histChart.data.datasets[0].data = counts;
    histChart.update();
  }

  function renderBoxplot() {
    if(!filtered.length) return;
    var vals = filtered.map(function(d){ return d.ndvi; }).sort(function(a,b){ return a - b; });
    var n = vals.length;
    var q1 = vals[Math.floor((n - 1) * 0.25)];
    var median = vals[Math.floor((n - 1) * 0.5)];
    var q3 = vals[Math.floor((n - 1) * 0.75)];
    var min = vals[0];
    var max = vals[vals.length - 1];
    // Placeholder: show min, q1, median, q3, max as stacked bars (simple visual)
    boxChart.data.labels = ['min','q1','median','q3','max'];
    boxChart.data.datasets[0].data = [min, q1, median, q3, max];
    boxChart.update();
  }

  // initialize
  wshow.textContent = smoothWindow.value;
  zshow.textContent = zthresh.value;

  window.loadCSVText = function(text) {
    rawData = parseCSV(text);
    if(rawData.length) {
      startDate.value = toInputDate(rawData[0].date);
      endDate.value = toInputDate(rawData[rawData.length - 1].date);
      applyFiltersAndRender();
    }
  };

  </script>
</body>
</html>
